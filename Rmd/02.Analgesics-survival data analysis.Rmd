---
title: "Association of analgesic medication use with survival among Black women with ovarian cance"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    toc_depth : 4
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type= "text/css">

. figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
```

```{r library}
library(here)
library(tidyverse)
library(labelled)
library(ggplot2)
library(ggforce)
library(gtsummary)
library(survminer)
library(survival)
theme_set(theme_classic())
theme_gtsummary_compact()
```

```{r load}
path <- fs::path("", "Volumes", "Peres_Research", "AACES2", "Analgesic medications and survival")
analgesics <-
  read_rds(paste0(here::here(), "/Cleaned imputed analgesics medication data_03212024.rds")) %>% 
  rename(imp_debulking = imp_NEW_dblkstat_treat_CA125)
```

```{r Labeling imputed data}
var_label(analgesics) <- list(refage = "Patient age", 
                         stage = "Clinical stage", imp_stage = "Clinical stage (imputed)", 
                         histotype2 = "Histotype", imp_histotype2 = "Histotype (imputed)", 
                         BMI_recent = "BMI (recent)", BMI_recent_grp = "BMI categories", 
                         imp_BMI_recent_grp = "BMI categories (imputed)", 
                         menopause = "Menopause", imp_menopause = "Menopause (imputed)",
                         smokcurrent2 = "Smoking status", 
                         paga = "Physical activity", imp_paga = "Physical activity (imputed)",
                         neoadj_treat = "Received neoadjuvant", 
                         imp_neoadj_treat = "Received neoadjuvant (imputed)", 
                         imp_debulking = "Debulking status (imputed)", 
                         NEW_dblkstat_treat_CA125 = "Debulking status", 
                         CCI_new = "CCI", CCI_new_Cat = "CCI categories",
                         imp_CCI_new_Cat = "CCI categories (imputed)",
                         aspirin = "Aspirin use",
                         aspirin_duration = "Aspirin duration (months)", 
                         aspirin_duration_cat = "Aspirin duration (cat)",
                         aspirin_duration_for_users = "Aspirin duration for users (months)",
                         aspirin_freq = "Aspirin frequency (Number of days per month)", 
                         aspirin_freq_cat = "Aspirin frequency (cat)",
                         aspirin_freq_for_users = "Aspirin frequency for users (Number of days per month)", 
                         aspirin_ind = "Aspirin indication",
                         nsaid = "Non-aspirin NSAID use", 
                         nsaid_duration = "Non-aspirin NSAID duration (months)", 
                         nsaid_duration_cat = "Non-aspirin NSAID duration for users (cat)",
                         nsaid_duration_for_users = "Non-aspirin NSAID duration for users (months)", 
                         nsaid_freq = "Non-aspirin NSAID frequency (Number of days per month)", 
                         nsaid_freq_cat = "Non-aspirin NSAID frequency for users (cat)",
                         nsaid_freq_for_users = "Non-aspirin NSAID frequency for users (Number of days per month)", 
                         nsaid_ind = "Non-aspirin NSAID indication",
                         aceta = "Acetaminophen use", 
                         acetaminophen_duration = "Acetaminophen duration (months)", 
                         acetaminophen_duration_cat = "Acetaminophen duration (cat)",
                         acetaminophen_duration_for_users = "Acetaminophen duration for users (months)", 
                         acetaminophen_freq = "Acetaminophen frequency (Number of days per month)", 
                         acetaminophen_freq_cat = "Acetaminophen frequency (cat)",
                         acetaminophen_freq_for_users = "Acetaminophen frequency for users (Number of days per month)", 
                         aceta_ind = "Acetaminophen indication",
                         site_2 = "Study site")
```

# I. Clinical table
```{r Clinical table}
analgesics %>% 
  select(refage, stage, imp_stage, histotype, 
         histotype2, imp_histotype2, 
         BMI_recent, imp_BMI_recent_grp,
         menopause, imp_menopause, smokcurrent2, 
         neoadj_treat, imp_neoadj_treat, 
         NEW_dblkstat_treat_CA125, imp_debulking,
         CCI_new, CCI_new_Cat, imp_CCI_new_Cat,
         paga, imp_paga) %>% 
  tbl_summary(type = list(
    c(neoadj_treat, imp_neoadj_treat,
      paga, imp_paga) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"
    )) %>% 
  bold_labels() %>% add_stat_label()
```

# II. Analgesics table
```{r Analgesics table}
analgesics %>% 
  select(aspirin, starts_with("aspirin_duration"), 
         starts_with("aspirin_freq"), 
         aspirin_ind,
         nsaid, starts_with("nsaid_duration"), 
         starts_with("nsaid_freq"), 
         nsaid_ind,
         aceta, starts_with("acetaminophen_duration"),
         starts_with("acetaminophen_freq"), 
         aceta_ind) %>% 
  tbl_summary(type = list(
    c(aspirin, nsaid, aceta) ~ "categorical"),
              statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label()
```

# III. Plots
## 1. Aspirin
median duration 73 (12, 480).  
Could do 5 years (60 months), or 100 months (8.3 years)  
median frequency 30 (2, 30).  
Could do <30 days vs 30 days.
```{r Plots}
analgesics %>% 
  select(aspirin_duration_for_users) %>% 
  group_by(aspirin_duration_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = aspirin_duration_for_users, y = n), 
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = aspirin_duration_for_users), 
           width = 0.5, fill = "darkblue")+
  labs(x = "Aspirin duration for users (months)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 5), zoom.size = 0.5)

analgesics %>% 
  select(aspirin_freq_for_users) %>% 
  group_by(aspirin_freq_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = aspirin_freq_for_users, y = n),
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = aspirin_freq_for_users), 
           width = 0.1, fill = "darkblue")+
  labs(x = "Aspirin frequency for users (Number of days per month)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 10))
```

## 2. NSAID
median duration 84 (3, 504).  
Same as aspirin?  
median frequency 20 (4, 150).  
The big peak is at 30 so could do <30 days vs ≥30 days?
```{r}
analgesics %>% 
  select(nsaid_duration_for_users) %>% 
  group_by(nsaid_duration_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = nsaid_duration_for_users, y = n), 
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = nsaid_duration_for_users), 
           width = 0.5, fill = "darkblue")+
  labs(x = "Non-aspirin NSAID duration for users (months)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 10))

analgesics %>% 
  select(nsaid_freq_for_users) %>% 
  group_by(nsaid_freq_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = nsaid_freq_for_users, y = n), 
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = nsaid_freq_for_users), 
           width = 0.1, fill = "darkblue")+
  labs(x = "Non-aspirin NSAID frequency for users (Number of days per month)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 10))
```

## 3. Acetaminophen
median duration 84 (4, 420).  
Same as aspirin?  
median frequency 10 (5, 60).  
The big peak is at 30 so could do <30 days vs ≥30 days?
```{r}
analgesics %>% 
  select(acetaminophen_duration_for_users) %>% 
  group_by(acetaminophen_duration_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = acetaminophen_duration_for_users, y = n), 
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = acetaminophen_duration_for_users), 
           width = 0.5, fill = "darkblue")+
  labs(x = "Acetaminophen duration for users (months)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 10))

analgesics %>% 
  select(acetaminophen_freq_for_users) %>% 
  group_by(acetaminophen_freq_for_users) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_area(aes(x = acetaminophen_freq_for_users, y = n), 
            alpha = 0.5, fill = "grey")+
  geom_bar(data = analgesics, aes(x = acetaminophen_freq_for_users), 
           width = 0.1, fill = "darkblue")+
  labs(x = "Acetaminophen frequency for users (Number of days per month)",
       y= "Number of patients")#+
  # facet_zoom(ylim = c(0, 10))
```


## 4. Using Never/Ever group
### How do the "Ever" groups overlap?

How many patients received none of the analgesics? `r analgesics %>% filter(aspirin == "No" & nsaid == "No" & aceta == "No") %>% nrow()`
```{r VennDiagram}
library(VennDiagram)

aspirin <- analgesics %>% filter(aspirin == "Yes")
nsaid <- analgesics %>% filter(nsaid == "Yes")
aceta <- analgesics %>% filter(aceta == "Yes")

# venn.diagram(
#   x = list(aspirin$suid, 
#            nsaid$suid,
#            aceta$suid
#            ),
#   category.names = c("Aspirin" , "NSAID", "Acetaminophen"),
#   filename = 'Patients with Analgesics.png',
#   disable.logging = TRUE,
#   output=TRUE,
#   
#   # Output features
#   imagetype="png" ,
#   height = 1000 , 
#   width = 1000 , 
#   resolution = 300,
#   compression = "lzw",
#   
#   # Circles
#   lwd = 2,
#   lty = 'blank',
#   fill = c(viridis::cividis(3)),
#   margin = 0.2,
#   
#   # Numbers
#   cex = .6,
#   fontface = "bold",
#   fontfamily = "sans",
#   # cat.pos = c(90, 0, 0),
#   cat.dist = c(0.08, 0.08, 0.04)
#   # ext.percent = 2
#   #ext.percent = 5
# )
knitr::include_graphics(paste0(here::here(), "/Patients with Analgesics.png"))
```

## 5. CCI
CCI is higher when patient have heart disease.
```{r}
analgesics %>% 
  select(CCI_new_Cat, aspirin_ind) %>% 
  tbl_summary(by = CCI_new_Cat) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05)

analgesics %>% 
  select(CCI_new, aspirin_ind) %>% 
  tbl_summary(by = aspirin_ind,
              statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05)

analgesics %>% 
  select(CCI_new, aspirin_ind) %>% 
  ggplot(aes(x = aspirin_ind, y = CCI_new))+
  geom_violin()
```

CCI is higher when patient have arthritis.
```{r}
analgesics %>% 
  select(CCI_new_Cat, nsaid_ind) %>% 
  tbl_summary(by = CCI_new_Cat) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p(test.args = all_tests("fisher.test") ~ list(workspace=2e9)
        ) %>% bold_p(t = 0.05)
analgesics %>% 
  select(CCI_new, nsaid_ind) %>% 
  tbl_summary(by = nsaid_ind,
              statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05)

analgesics %>% 
  select(CCI_new, nsaid_ind) %>% 
  ggplot(aes(x = nsaid_ind, y = CCI_new))+
  geom_violin()
```

CCI is higher when patient have arthritis and injury.
```{r}
analgesics %>% 
  select(CCI_new_Cat, aceta_ind) %>% 
  tbl_summary(by = CCI_new_Cat) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p(test.args = all_tests("fisher.test") ~ list(workspace=2e9)
        ) %>% bold_p(t = 0.05)
analgesics %>% 
  select(CCI_new, aceta_ind) %>% 
  tbl_summary(by = aceta_ind,
              statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05)

analgesics %>% 
  select(CCI_new, aceta_ind) %>% 
  ggplot(aes(x = aceta_ind, y = CCI_new))+
  geom_violin()
```

# IV. Analysis : users vs non users
## 1. Tables by analgesics
```{r}
analgesics %>% 
  select(refage, stage, imp_stage, histotype, 
         histotype2, imp_histotype2, 
         BMI_recent, imp_BMI_recent_grp,
         menopause, imp_menopause, smokcurrent2, 
         neoadj_treat, imp_neoadj_treat, 
         NEW_dblkstat_treat_CA125, imp_debulking,
         CCI_new, CCI_new_Cat, imp_CCI_new_Cat,
         paga, imp_paga,
         aspirin, nsaid, aceta) %>% 
  tbl_summary(by = aspirin,
              type = list(
    c(aspirin, nsaid, aceta,
      neoadj_treat, imp_neoadj_treat,
      paga, imp_paga) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05) %>% 
  modify_caption("**By Aspirin Use** (N = {N})")

analgesics %>% 
  select(refage, stage, imp_stage, histotype, 
         histotype2, imp_histotype2, 
         BMI_recent, imp_BMI_recent_grp,
         menopause, imp_menopause, smokcurrent2, 
         neoadj_treat, imp_neoadj_treat, 
         NEW_dblkstat_treat_CA125, imp_debulking,
         CCI_new, CCI_new_Cat, imp_CCI_new_Cat,
         paga, imp_paga,
         aspirin, nsaid, aceta) %>% 
  tbl_summary(by = nsaid,
              type = list(
    c(aspirin, nsaid, aceta,
      neoadj_treat, imp_neoadj_treat,
      paga, imp_paga) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05) %>% 
  modify_caption("**By NSAID Use** (N = {N})")

analgesics %>% 
  select(refage, stage, imp_stage, histotype, 
         histotype2, imp_histotype2, 
         BMI_recent, imp_BMI_recent_grp,
         menopause, imp_menopause, smokcurrent2, 
         neoadj_treat, imp_neoadj_treat, 
         NEW_dblkstat_treat_CA125, imp_debulking,
         paga, imp_paga,
         CCI_new, CCI_new_Cat, imp_CCI_new_Cat,
         aspirin, nsaid, aceta) %>% 
  tbl_summary(by = aceta,
              type = list(
    c(aspirin, nsaid, aceta,
      neoadj_treat, imp_neoadj_treat,
      paga, imp_paga) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"
  )) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% bold_p(t = 0.05) %>% 
  modify_caption("**By Acetaminophen Use** (N = {N})")
```

## 2. Survival
### KM
#### Yes/No
<div class = "row">
<div class = "col-md-4">
```{r KM, fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aspirin, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))

```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ nsaid, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aceta, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>

#### Duration
<div class = "row">
<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aspirin_duration_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))

```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ nsaid_duration_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ acetaminophen_duration_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>

#### Frequency
<div class = "row">
<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aspirin_freq_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))

```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ nsaid_freq_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ acetaminophen_freq_cat, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>

#### Indication
<div class = "row">
<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aspirin_ind, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))

```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ nsaid_ind, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-4">
```{r fig.height = 8}
ggsurvplot(survfit(Surv(os_time, os_event) ~ aceta_ind, 
                   data=analgesics),
           title = "OS Analysis",
           font.main = c(20, "bold", "black"),
           font.x = c(18, "bold", "black"),
           font.y = c(18, "bold", "black"),
           font.legend = c(16, "black"),
           font.tickslab = c(16, "bold", "black"),
           size = 1.5,

           xlab = "Time in months",
           legend = "top",
           legend.title = "",
           pval = TRUE,
           conf.int = FALSE,
           # Censor
           censor = TRUE
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>


### Model 1 - adjust for age, study site, stage, and histotype
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, stage, 
                              histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>%
  cox.zph()
```

### Model 2 - + BMI_recent_grp, smokcurrent2, CCI_new_Cat + physical activity
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, stage, 
                              histotype2, 
                              BMI_recent_grp, smokcurrent2, 
                              CCI_new_Cat, paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2) +
                BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2) +
                BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
              data = analgesics) %>%
  cox.zph()
```

### Model 3 - + indication
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_ind,
                              nsaid_ind, 
                              aceta_ind,
                              refage, site_2, stage, 
                              histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>%
  cox.zph()
```


# V. Using a cut point
## Duration cut point
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_duration_cat,
                              nsaid_duration_cat, 
                              acetaminophen_duration_cat,
                              refage, site_2, stage, 
                              histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage + site_2 + stage + strata(histotype2),
      data = analgesics)  %>%
  cox.zph()
```

```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_duration_cat,
                              nsaid_duration_cat, 
                              acetaminophen_duration_cat,
                              refage, site_2, stage, 
                              histotype2,
                              BMI_recent_grp, smokcurrent2, 
                              CCI_new_Cat, paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + 
                refage + site_2 + stage + strata(histotype2) + BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage + site_2 + stage + strata(histotype2) + BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
      data = analgesics)  %>%
  cox.zph()
```


## Frequency cut point
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_freq_cat,
                              nsaid_freq_cat, 
                              acetaminophen_freq_cat,
                              refage, site_2, stage, 
                              histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + refage + site_2 + stage + strata(histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + refage + site_2 + stage + strata(histotype2),
      data = analgesics)  %>%
  cox.zph()
```

```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_freq_cat,
                              nsaid_freq_cat, 
                              acetaminophen_freq_cat,
                              refage, site_2, stage, 
                              histotype2,
                              BMI_recent_grp, smokcurrent2, 
                              CCI_new_Cat, paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat +
                refage + site_2 + stage + strata(histotype2) + BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + 
        refage + site_2 + stage + strata(histotype2) + BMI_recent_grp + smokcurrent2 + CCI_new_Cat + paga,
      data = analgesics)  %>%
  cox.zph()
```

# VI. Sensitivity analysis - Yes/No - adjusting for treatment 

### Model 1 + NEW_dblkstat_treat_CA125
```{r Sensitivity analysis adjusting for treatment}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, stage, 
                              histotype2, NEW_dblkstat_treat_CA125) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2) + NEW_dblkstat_treat_CA125,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + strata(histotype2) + NEW_dblkstat_treat_CA125,
              data = analgesics)  %>%
  cox.zph()
```

### Model 2 - + BMI_recent_grp, smokcurrent2, CCI_new_Cat + paga + NEW_dblkstat_treat_CA125
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, stage, 
                              histotype2, NEW_dblkstat_treat_CA125,
                              BMI_recent_grp, smokcurrent2, 
                              CCI_new_Cat, paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + 
                histotype2 + paga + NEW_dblkstat_treat_CA125 +
                BMI_recent_grp + smokcurrent2 + CCI_new_Cat,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + stage + 
        histotype2 + paga + NEW_dblkstat_treat_CA125 +
                BMI_recent_grp + smokcurrent2 + CCI_new_Cat,
              data = analgesics) %>%
  cox.zph()
```

### Model 3 - + indication + NEW_dblkstat_treat_CA125
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_ind,
                              nsaid_ind, 
                              aceta_ind,
                              refage, site_2, stage, 
                              histotype2, NEW_dblkstat_treat_CA125) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + stage + strata(histotype2) + NEW_dblkstat_treat_CA125,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + stage + strata(histotype2) + NEW_dblkstat_treat_CA125,
              data = analgesics)  %>%
  cox.zph()
```


# VII. Multiple imputation - HR

## 1. Yes/No
### Model 1 - adjust for age, study site, imp_stage, and imp_histotype2
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, imp_stage, 
                              imp_histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>%
  cox.zph()
```

### Model 2 - + imp_BMI_recent_grp, smokcurrent2, imp_CCI_new_Cat + imp_paga
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, imp_stage, 
                              imp_histotype2, 
                              imp_BMI_recent_grp, smokcurrent2, 
                              imp_CCI_new_Cat, imp_paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + 
                strata(imp_histotype2) +
                imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2) +
                imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics) %>%
  cox.zph()
```

### Model 3 - + indication
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_ind,
                              nsaid_ind, 
                              aceta_ind,
                              refage, site_2, imp_stage, 
                              imp_histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>%
  cox.zph()
```


## 2. Using a cut point
### Duration cut point
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_duration_cat,
                              nsaid_duration_cat, 
                              acetaminophen_duration_cat,
                              refage, site_2, imp_stage, 
                              imp_histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage + site_2 + imp_stage + strata(imp_histotype2),
      data = analgesics)  %>%
  cox.zph()
```

```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_duration_cat,
                              nsaid_duration_cat, 
                              acetaminophen_duration_cat,
                              refage, site_2, imp_stage, 
                              imp_histotype2,
                              imp_BMI_recent_grp, smokcurrent2, 
                              imp_CCI_new_Cat, imp_paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat +
                refage + site_2 + imp_stage + strata(imp_histotype2) + imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_duration_cat + nsaid_duration_cat + acetaminophen_duration_cat + refage +
        site_2 + imp_stage + strata(imp_histotype2) + imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
      data = analgesics)  %>%
  cox.zph()
```

### Frequency cut point
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_freq_cat,
                              nsaid_freq_cat, 
                              acetaminophen_freq_cat,
                              refage, site_2, imp_stage, 
                              imp_histotype2) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + 
                refage + site_2 + imp_stage + strata(imp_histotype2),
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + 
        refage + site_2 + imp_stage + strata(imp_histotype2),
      data = analgesics)  %>%
  cox.zph()
```

```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_freq_cat,
                              nsaid_freq_cat, 
                              acetaminophen_freq_cat,
                              refage, site_2, imp_stage, 
                              imp_histotype2,
                              imp_BMI_recent_grp, smokcurrent2, 
                              imp_CCI_new_Cat, imp_paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + 
                refage + site_2 + imp_stage + strata(imp_histotype2) + imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
           event = analgesics$os_event) ~ aspirin_freq_cat + nsaid_freq_cat + acetaminophen_freq_cat + refage +
        site_2 + imp_stage + strata(imp_histotype2) + imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
      data = analgesics)  %>%
  cox.zph()
```

## 3. Adjusting for treatment 

### Model 1 + imp_debulking
```{r Adjusting for treatment}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, imp_stage, 
                              imp_histotype2, imp_debulking) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2) + imp_debulking,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2) + imp_debulking,
              data = analgesics)  %>%
  cox.zph()
```

### Model 2 - + imp_BMI_recent_grp, smokcurrent2, imp_CCI_new_Cat + imp_paga + imp_debulking
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin, nsaid, aceta,
                              refage, site_2, imp_stage, 
                              imp_histotype2, imp_debulking,
                              imp_BMI_recent_grp, smokcurrent2, 
                              imp_CCI_new_Cat, imp_paga) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + 
                strata(imp_histotype2) + imp_debulking +
                imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin + nsaid + aceta + refage + site_2 + imp_stage + strata(imp_histotype2) + imp_debulking +
                imp_BMI_recent_grp + smokcurrent2 + imp_CCI_new_Cat + imp_paga,
              data = analgesics) %>%
  cox.zph()
```

### Model 3 - + indication + imp_debulking
```{r}
tbl1 <- analgesics %>% select(os_event, os_time,
                              aspirin_ind,
                              nsaid_ind, 
                              aceta_ind,
                              refage, site_2, imp_stage, 
                              imp_histotype2, imp_debulking) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = analgesics$os_time,
                             event = analgesics$os_event)),
                   exponentiate = TRUE) %>% 
  bold_labels() %>% italicize_levels() %>% 
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl2 <- coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + imp_stage + strata(imp_histotype2) + imp_debulking,
              data = analgesics)  %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  bold_p(t = .05) %>% 
  add_nevent(location = "level") %>% add_n(location = "level")
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Univariable**", "**Multivariable**"))
```

PH assumption
```{r}
coxph(Surv(time = analgesics$os_time, 
                   event = analgesics$os_event) ~ aspirin_ind + nsaid_ind + aceta_ind + refage + site_2 + imp_stage + strata(imp_histotype2) + imp_debulking,
              data = analgesics)  %>%
  cox.zph()
```









